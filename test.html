<!DOCTYPE html>
<html>
	<!-- 流程为：手机号验证 → 参数解码 → 签名验证 → 招行验证 → 生成小程序链接 -->

	<head>
		<meta charset="UTF-8">
		<title>福奈特</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<!-- 新增禁止缓存的meta标签 -->
		<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
		<meta http-equiv="Pragma" content="no-cache">
		<meta http-equiv="Expires" content="0">
		<style>
			/* 增强型响应式布局 */
			html,
			body {
				width: 100%;
				min-height: 100vh;
				margin: 0;
				padding: 20px 0;
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: flex-start;
			}

			#webview {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				border: none;
				display: none;
			}

			/* 响应式Logo */
			#logo {
				width: min(60%, 150px);
				aspect-ratio: 1;
				object-fit: contain;
				margin: 5vh 0;
			}

			/* 增强型表单布局 */
			#auth-form {
				width: 90%;
				max-width: 400px;
				display: flex;
				flex-direction: column;
				gap: 1.2rem;
				padding: 0 5%;
			}


			/* 加固按钮样式 */
			button {
				width: 100%;
				max-width: 400px;
				padding: 14px;
				background: #29b1ba;
				color: white;
				border: none;
				border-radius: 8px;
				font-size: 16px;
				cursor: pointer;
				transition:
					background 0.3s,
					opacity 0.3s;
				position: relative;
			}

			button:disabled {
				background: #a0d8dd;
				cursor: not-allowed;
			}


			/* 增强型Toast */
			.toast {
				position: fixed;
				bottom: 30px;
				left: 50%;
				transform: translateX(-50%);
				background: rgba(40, 40, 40, 0.95);
				color: white;
				padding: 12px 24px;
				border-radius: 25px;
				font-size: 14px;
				white-space: nowrap;
				animation: slideUp 0.3s ease-out;
				box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
			}

			@keyframes slideUp {
				from {
					opacity: 0;
					transform: translate(-50%, 20px);
				}

				to {
					opacity: 1;
					transform: translate(-50%, 0);
				}
			}

			/* 移动端优化 */
			@media (max-width: 480px) {
				html {
					font-size: 14px;
				}

				#logo {
					margin: 3vh 0;
				}

				input {
					padding: 10px 12px;
					font-size: 15px;
				}

				button {
					padding: 12px;
					font-size: 15px;
				}
			}
		</style>
	</head>

	<body>
		<!-- 添加 logo -->
		<img id="logo" alt="福奈特 logo">
		<!-- 新增手机号验证表单 -->
		<form id="auth-form">
			<button type="submit">跳转到福奈特小程序</button>
		</form>
		<!-- <iframe id="webview" allowfullscreen></iframe> -->
		<!-- Toast提示容器 -->
		<div id="toast" class="toast"></div>

		<script>
			// 新增按钮状态管理
			let isSubmitting = false;

			// 系统配置
			const CONFIG = {
				HOST: "https://tapp-test.fornet.com.cn:8001",
				API_ENDPOINT: '/dologin/applet/weixin/generateUrlLink',
				VERIFY_ENDPOINT: '/dologin/applet/login/verifyCmbc',
				TIMEOUT: 30000,
				LOGO_PATH: '/img/fornetLogo.png' // 新增LOGO路径配置
			};
			// 初始化Logo地址
			document.addEventListener('DOMContentLoaded', () => {
				document.getElementById('logo').src = CONFIG.HOST + CONFIG.LOGO_PATH;
			});
			const toast = document.getElementById('toast');
			toast.style.display = 'none';
			// Toast提示方法
			function showToast(message, duration = 2500) {

				toast.textContent = message;
				toast.style.display = 'block';
				setTimeout(() => {
					toast.style.display = 'none';
				}, duration);
			}


			// 初始化表单验证
			function initFormValidation() {
				const form = document.getElementById('auth-form');

				// 修改表单提交处理
				form.addEventListener('submit', async function(e) {
					e.preventDefault();
					if (isSubmitting) return;

					isSubmitting = true;
					const submitBtn = form.querySelector('button');
					submitBtn.disabled = true;
					submitBtn.style.opacity = 0.8;

					try {
						form.style.display = 'none';
						await initializeService();
					} finally {
						isSubmitting = false;
						submitBtn.disabled = false;
						submitBtn.style.opacity = 1;
					}
				});
			}

			// Base64解码工具（兼容URL Safe）
			function safeBase64Decode(str) {
				try {
					return decodeURIComponent(atob(str.replace(/_/g, '/').replace(/-/g, '+'))
						.split('')
						.map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))
						.join(''));
				} catch (e) {
					showToast('参数解码失败');
					throw new Error('参数解码失败');
				}
			}

			// 增强版JSON解析方法
			function safeJsonParse(str) {
				try {
					// 替换中文引号/全角符号
					const sanitized = str
						.replace(/[“”]/g, '"')
						.replace(/‘’/g, "'")
						.replace(/\\/g, '\\\\');

					return JSON.parse(sanitized);
				} catch (e) {
					showToast(`数据解析失败: ${e.message}`);
					throw new Error(`数据解析失败: ${e.message}`);
				}
			}

			// 增强参数验证
			function validateParams(data) {
				const requiredFields = [
					'timestamp', 'nonce', 'flag',
					'host', 'number'
				];

				requiredFields.forEach(field => {
					// showToast("缺少必要参数");
					if (!data[field]) throw new Error(`缺少必要参数: ${field}`);
				});

			}

			// 新增验证接口调用逻辑
			async function verifyCmbcRequest(data, sign) {
				const controller = new AbortController();
				const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);

				// 在请求中添加时间戳参数防止缓存
				const url = new URL(CONFIG.HOST + CONFIG.VERIFY_ENDPOINT);
				url.searchParams.append('t', Date.now());

				const response = await fetch(url, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'Cache-Control': 'no-cache, no-store, must-revalidate',
						'Pragma': 'no-cache',
						'Expires': '0'
					},
					body: JSON.stringify({
						data,
						sign
					}),
					signal: controller.signal
				});

				clearTimeout(timeoutId);

				if (!response.ok) {
					const error = await response.json().catch(() => ({}));
					showToast(error.msg || `验证请求失败: HTTP ${response.status}`);
					throw new Error(error.msg || `验证请求失败: HTTP ${response.status}`);
				}

				const result = await response.json();
				if (result.code !== 200) {
					showToast(result.msg || '验证未通过');
					throw new Error(result.msg || '验证未通过');
				}

				return result;
			}

			// 核心业务逻辑
			async function initializeService() {
				// const webview = document.getElementById('webview');

				try {
					// 获取URL参数
					const urlParams = new URLSearchParams(location.search);
					const [encodedData, signature] = [urlParams.get('data'), urlParams.get('sign')];

					// 参数校验
					if (!encodedData || !signature) {
						showToast("请求参数不完整");
						throw new Error('请求参数不完整');

					}

					// 解码验证（原有逻辑保持不变）
					const decodedStr = safeBase64Decode(encodedData);
					const originalData = safeJsonParse(decodedStr);
					validateParams(originalData);

					// 新增验证接口调用
					await verifyCmbcRequest(encodedData, signature);

					// 原有生成链接逻辑
					const requestPayload = {
						env_version: 'trial', //默认值"release"。要打开的小程序版本。正式版为 "release"，体验版为"trial"，开发版为"develop"，仅在微信外打开时生效
						path: '/pages/index/index',
						query: `flag=${originalData.flag}&cmbcUserId=${originalData.number}`
					};

					const controller = new AbortController();
					const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);

					// 在请求中添加时间戳参数防止缓存
					const apiUrl = new URL(CONFIG.HOST + CONFIG.API_ENDPOINT);
					apiUrl.searchParams.append('t', Date.now());

					const response = await fetch(apiUrl, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
							'Cache-Control': 'no-cache, no-store, must-revalidate',
							'Pragma': 'no-cache',
							'Expires': '0'
						},
						body: JSON.stringify(requestPayload),
						signal: controller.signal
					});

					clearTimeout(timeoutId);
					if (!response.ok) {
						showToast(`请求失败: HTTP ${response.status}`)
						throw new Error(`请求失败: HTTP ${response.status}`);
					}

					const responseData = await response.json();
					if (responseData.code !== 200 || !responseData.msg) {
						showToast(responseData.msg || '无效的服务器响应')
						throw new Error(responseData.msg || '无效的服务器响应');
					}
					// 新增强制跳转逻辑
					const url = responseData.msg;
					handleRedirect(url);


					// 显示webview
					// webview.style.display = 'block';
					// webview.src = responseData.msg;

				} catch (error) {
					document.getElementById('auth-form').style.display = 'flex';
					// document.getElementById('webview').style.display = 'none';
					showToast(error.message);
					throw error;
				}
			}
			// 新增跳转处理函数
			function handleRedirect(url) {
				const isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
				const isWechat = /MicroMessenger/.test(navigator.userAgent);

				// 在跳转URL中添加时间戳参数防止缓存
				const redirectUrl = new URL(url);
				redirectUrl.searchParams.append('t', Date.now());

				if (isWechat) {
					// 微信内置浏览器直接打开
					window.location.href = redirectUrl.toString();
				} else if (isiOS) {
					// iOS 处理方案
					showIOSRedirectPrompt(redirectUrl.toString());
				} else {
					// Android 及其他设备
					attemptDirectRedirect(redirectUrl.toString());
				}
			}
			// 修改后的跳转逻辑
			function attemptDirectRedirect(url) {
				// 方法1：使用iframe迂回跳转
				const iframe = document.createElement('iframe');
				iframe.style.display = 'none';
				iframe.src = url;
				document.body.appendChild(iframe);
			}

			// 新增WebView特殊处理
			function showWebViewFallback() {
				const isAndroid = /Android/.test(navigator.userAgent);
				const isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

				let instructions = '';
				if (isAndroid) {
					instructions = `请点击右上角菜单，选择"在浏览器打开"`;
				} else if (isiOS) {
					instructions = `请长按右上角，选择"在Safari中打开"`;
				}

				if (instructions) {
					const tip = document.createElement('div');
					tip.innerHTML = `
			      <p style="color:#666;text-align:center;margin-top:20px;">
			        ${instructions}
			      </p>
			    `;
					document.getElementById('auth-form').appendChild(tip);
				}
			}

			// 修改iOS跳转提示处理
			function showIOSRedirectPrompt(url) {
				const form = document.getElementById('auth-form');
				form.innerHTML = `
			    <p style="text-align:center;color:#666;margin-bottom:15px;">
			      点击下方按钮跳转到微信<br>
			      <small>（iOS系统需要用户主动触发）</small>
			    </p>
			    <button type="button" id="ios-redirect-btn" onclick="handleIOSRedirect('${url}')">立即跳转</button>
			  `;
				form.style.display = 'flex';
			}

			// 专用iOS处理函数
			function handleIOSRedirect(url) {
				// 先尝试直接跳转
				window.location.href = url;

				// 备用方案：使用a标签点击
				setTimeout(() => {
					const link = document.createElement('a');
					link.href = url;
					link.style.display = 'none';
					document.body.appendChild(link);
					link.click();
					document.body.removeChild(link);
				}, 300);
			}
			// 修改启动逻辑
			document.addEventListener('DOMContentLoaded', () => {
				initFormValidation(); // 初始化表单验证
				// 心跳监测
				setInterval(() => {
					if (document.visibilityState === 'visible') {
						console.log('[Heartbeat] System active');
					}
				}, 60000);
			});
		</script>
	</body>
</html>
